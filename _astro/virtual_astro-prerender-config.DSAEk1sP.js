var S=class{constructor(e={}){this.htmlCache=new Map,this.cssCache=new Set,this.observers=new Map,this.manifest=null,this.manifestLoaded=!1,this.baseCssLoaded=!1,this.legacyCssLoaded=!1,this.stats={totalLoads:0,cacheHits:0,cacheMisses:0,errors:0,totalLoadTime:0,totalBytes:0},this.detailedStats=new Map;var t,o,s,a,c,i,r,f,m,n,h,l,d,u;let g=(t=e.baseUrl)!=null?t:"/prerendered";this.config={baseUrl:g,cssModules:(o=e.cssModules)!=null?o:!1,manifestUrl:(s=e.manifestUrl)!=null?s:`${g}/manifest.json`,baseCssUrl:(a=e.baseCssUrl)!=null?a:`${g}/base.css`,legacyCssUrl:(c=e.legacyCssUrl)!=null?c:`${g}/lazy-components.css`,preloadCSS:(i=e.preloadCSS)!=null?i:!1,cacheHTML:(r=e.cacheHTML)!=null?r:!0,enableRetry:(f=e.enableRetry)!=null?f:!0,maxRetries:(m=e.maxRetries)!=null?m:3,retryDelay:(n=e.retryDelay)!=null?n:1e3,debug:(h=e.debug)!=null?h:!1,onLoad:(l=e.onLoad)!=null?l:(()=>{}),onError:(d=e.onError)!=null?d:(()=>{}),onCSSLoad:(u=e.onCSSLoad)!=null?u:(()=>{})},this.log("LazyHTMLLoader initialized",this.config)}log(e,...t){this.config.debug&&console.log(`[LazyHTMLLoader] ${e}`,...t)}async fetchWithRetry(e,t=this.config.maxRetries){for(let o=1;o<=t;o++){try{this.log(`Fetching ${e} (attempt ${o}/${t})`);let s=await fetch(e);if(s.ok)return s;if(o===t)throw new Error(`HTTP ${s.status}: ${s.statusText}`);if(s.status===404)throw new Error(`Not found: ${e}`);this.log(`Fetch failed with status ${s.status}, retrying...`)}catch(s){if(o===t)throw s;this.log(`Fetch error: ${s}, retrying...`)}o<t&&await new Promise(s=>setTimeout(s,this.config.retryDelay*o))}throw new Error(`Failed to fetch ${e} after ${t} attempts`)}async loadManifest(){if(this.manifestLoaded)return;let e=performance.now();try{let t=await(this.config.enableRetry?this.fetchWithRetry(this.config.manifestUrl):fetch(this.config.manifestUrl));if(!t.ok)throw new Error(`Failed to load manifest: ${t.statusText}`);this.manifest=await t.json(),this.manifestLoaded=!0;let o=performance.now()-e;this.log(`Manifest loaded in ${o.toFixed(2)}ms`,this.manifest),this.config.onCSSLoad(this.config.manifestUrl,o)}catch(t){console.error("Failed to load CSS manifest:",t),this.config.cssModules=!1,this.manifestLoaded=!0}}async loadBaseCSS(){if(this.baseCssLoaded||(await this.loadManifest(),!this.manifest))return;let e=performance.now();return new Promise((t,o)=>{let s=document.createElement("link");if(s.rel="stylesheet",s.href=this.config.baseCssUrl,s.onload=()=>{this.baseCssLoaded=!0;let a=performance.now()-e;this.log(`Base CSS loaded in ${a.toFixed(2)}ms`),this.config.onCSSLoad(this.config.baseCssUrl,a),t()},s.onerror=()=>{console.error("Failed to load base CSS"),o(new Error("Failed to load base CSS"))},this.config.preloadCSS){let a=document.createElement("link");a.rel="preload",a.as="style",a.href=this.config.baseCssUrl,document.head.appendChild(a)}document.head.appendChild(s)})}async loadComponentCSS(e){if(!this.config.cssModules||!this.manifest)return;let t=this.manifest.components[e];if(!t){this.log(`No CSS file for component: ${e}`);return}if(this.cssCache.has(t)){this.log(`CSS already loaded: ${t}`);return}let o=performance.now(),s=`${this.config.baseUrl}/${t}`;return new Promise((a,c)=>{let i=document.createElement("link");if(i.rel="stylesheet",i.href=s,i.onload=()=>{this.cssCache.add(t);let r=performance.now()-o;this.log(`Component CSS loaded in ${r.toFixed(2)}ms: ${t}`),this.config.onCSSLoad(t,r),a()},i.onerror=()=>{console.error(`Failed to load component CSS: ${t}`),c(new Error(`Failed to load CSS: ${t}`))},this.config.preloadCSS){let r=document.createElement("link");r.rel="preload",r.as="style",r.href=s,document.head.appendChild(r)}document.head.appendChild(i)})}async loadLegacyCSS(){if(this.legacyCssLoaded)return;let e=performance.now();return new Promise((t,o)=>{let s=document.createElement("link");if(s.rel="stylesheet",s.href=this.config.legacyCssUrl,s.onload=()=>{this.legacyCssLoaded=!0;let a=performance.now()-e;this.log(`Legacy CSS loaded in ${a.toFixed(2)}ms`),this.config.onCSSLoad(this.config.legacyCssUrl,a),t()},s.onerror=()=>{console.error("Failed to load legacy CSS"),o(new Error("Failed to load lazy components CSS"))},this.config.preloadCSS){let a=document.createElement("link");a.rel="preload",a.as="style",a.href=this.config.legacyCssUrl,document.head.appendChild(a)}document.head.appendChild(s)})}async load(e){let t=performance.now();try{if(this.config.cacheHTML&&this.htmlCache.has(e)){this.stats.cacheHits++,this.log(`Cache hit: ${e}`);let n=this.htmlCache.get(e),h=new Blob([n]).size,l=performance.now()-t;this.stats.totalLoads++,this.stats.totalLoadTime+=l;let d={duration:l,bytes:h,fromCache:!0,timestamp:Date.now()};return this.detailedStats.set(e,d),this.config.onLoad(e,{duration:l,bytes:h,fromCache:!0}),n}this.stats.cacheMisses++,this.config.cssModules?(await this.loadBaseCSS().catch(n=>{console.warn("Failed to load base CSS:",n)}),await this.loadComponentCSS(e).catch(n=>{console.warn(`Failed to load CSS for ${e}:`,n)})):await this.loadLegacyCSS().catch(n=>{console.warn("Failed to load legacy CSS:",n)});let o=`${this.config.baseUrl}/${e}.html`,s=await(this.config.enableRetry?this.fetchWithRetry(o):fetch(o));if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);let a=await s.text(),c=new Blob([a]).size;this.config.cacheHTML&&this.htmlCache.set(e,a);let i=performance.now()-t;this.stats.totalLoads++,this.stats.totalLoadTime+=i,this.stats.totalBytes+=c,this.log(`Loaded ${e} in ${i.toFixed(2)}ms (${c} bytes)`);let r=[],f=new PerformanceObserver(n=>{n.getEntries().forEach(h=>{let l=h;if(l.startTime>=t-50){let d=l.transferSize||l.decodedBodySize||l.encodedBodySize||0;r.push({url:l.name,bytes:d,duration:l.duration,type:l.initiatorType}),this.stats.totalBytes+=d}})});try{f.observe({entryTypes:["resource"],buffered:!0}),setTimeout(()=>f.disconnect(),6e3)}catch{this.log("PerformanceObserver failed");try{f.observe({entryTypes:["resource"]})}catch{}}let m={duration:i,bytes:c,fromCache:!1,timestamp:Date.now(),secondaryAssets:r};return this.detailedStats.set(e,m),this.config.onLoad(e,{duration:i,bytes:c,fromCache:!1,secondaryAssets:r}),a}catch(o){this.stats.errors++;let s=o instanceof Error?o:new Error(String(o));throw this.log(`Error loading ${e}:`,s),this.config.onError(e,s),s}}async inject(e,t){let o=await this.load(e),s=document.querySelector(t);if(s)s.innerHTML=o,this.log(`Injected ${e} into ${t}`);else{let a=new Error(`Target element not found: ${t}`);throw this.config.onError(e,a),a}}observeAndLoad(e,t,o){let s=document.querySelector(t);if(!s){console.warn(`Target element not found: ${t}`);return}let a=new IntersectionObserver(c=>{c.forEach(i=>{i.isIntersecting&&(this.log(`Component ${e} entered viewport`),this.inject(e,t).catch(r=>{console.error(`Failed to inject ${e}:`,r)}),a.disconnect(),this.observers.delete(e))})},o||{rootMargin:"100px"});a.observe(s),this.observers.set(e,a),this.log(`Observing ${e} at ${t}`)}async preload(e){await this.load(e)}async preloadBatch(e){this.log(`Preloading ${e.length} components:`,e),await Promise.all(e.map(t=>this.preload(t)))}getStats(){return{totalLoads:this.stats.totalLoads,cacheHits:this.stats.cacheHits,cacheMisses:this.stats.cacheMisses,errors:this.stats.errors,averageLoadTime:this.stats.totalLoads>0?this.stats.totalLoadTime/this.stats.totalLoads:0,totalBytes:this.stats.totalBytes}}getDetailedHistory(){return Array.from(this.detailedStats.entries()).map(([e,t])=>({componentName:e,...t})).sort((e,t)=>t.timestamp-e.timestamp)}clearCache(){this.htmlCache.clear(),this.log("HTML cache cleared")}clearCSSCache(){this.cssCache.clear(),this.baseCssLoaded=!1,this.legacyCssLoaded=!1,this.manifestLoaded=!1,this.manifest=null,this.log("CSS cache cleared")}disconnectAll(){this.observers.forEach(e=>e.disconnect()),this.observers.clear(),this.log("All observers disconnected")}reset(){this.clearCache(),this.clearCSSCache(),this.disconnectAll(),this.stats={totalLoads:0,cacheHits:0,cacheMisses:0,errors:0,totalLoadTime:0,totalBytes:0},this.detailedStats.clear(),this.log("LazyHTMLLoader reset")}};function y(e){return new S(e)}new S;const C="/astro-prerender-plugin/prerendered";export{y as S,C as p};
